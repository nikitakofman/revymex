import React from "react";

const DuplicateDyna = () => {
  // POC: Dynamic Element Tree Duplicator

  // Paste your node tree from clipboard into this variable
  const inputNodeTree = [
    {
      id: "As0WCJv0sTl2_a5db2UWY",
      type: "frame",
      style: {
        position: "relative",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "",
        top: "",
        zIndex: "",
        transform: "",
      },
      inViewport: true,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "viewport-1440",
      isDynamic: true,
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      dynamicViewportId: "viewport-1440",
      variantResponsiveId: "n2S_BvXTa8GsBw6qCBUa7",
    },
    {
      id: "FRkSqx5xLg9P4W-Sm4G-P",
      type: "frame",
      style: {
        position: "relative",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "",
        top: "",
        zIndex: "",
        transform: "",
      },
      inViewport: true,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "viewport-768",
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      isDynamic: true,
      variantResponsiveId: "n2S_BvXTa8GsBw6qCBUa7",
      dynamicViewportId: "viewport-768",
    },
    {
      id: "_X9cMMQpXi_hEW4MZ4_2w",
      type: "frame",
      style: {
        position: "relative",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "",
        top: "",
        zIndex: "",
        transform: "",
      },
      inViewport: true,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "viewport-375",
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      isDynamic: true,
      variantResponsiveId: "n2S_BvXTa8GsBw6qCBUa7",
      dynamicViewportId: "viewport-375",
    },
    {
      id: "rVkKT7a3XFKMjvM2rlFO9",
      type: "frame",
      style: {
        position: "absolute",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "503.33343505859375px",
        top: "0px",
      },
      isDynamic: false,
      inViewport: false,
      parentId: null,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      isVariant: true,
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
      variantResponsiveId: "Wwwb1vAbHcIpHpNV5tTDe",
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      independentStyles: {
        left: true,
        top: true,
        position: true,
      },
      position: {
        x: 503.33343505859375,
        y: 0,
      },
      dynamicParentId: "As0WCJv0sTl2_a5db2UWY",
      variantParentId: "As0WCJv0sTl2_a5db2UWY",
      dynamicViewportId: "viewport-1440",
    },
    {
      id: "HdRQOn2pJO9DIenmjJJjW",
      type: "frame",
      style: {
        position: "absolute",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "503.33343505859375px",
        top: "0px",
      },
      isDynamic: false,
      inViewport: false,
      parentId: null,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      isVariant: true,
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
      variantResponsiveId: "Wwwb1vAbHcIpHpNV5tTDe",
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      independentStyles: {
        left: true,
        top: true,
        position: true,
      },
      position: {
        x: 503.33343505859375,
        y: 0,
      },
      dynamicParentId: "FRkSqx5xLg9P4W-Sm4G-P",
      variantParentId: "FRkSqx5xLg9P4W-Sm4G-P",
      dynamicViewportId: "viewport-768",
    },
    {
      id: "y5GAuftHf033N31R1IbKN",
      type: "frame",
      style: {
        position: "absolute",
        width: "303.33333333333337px",
        height: "306.6666666666667px",
        backgroundColor: "#97cffc",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        left: "503.33343505859375px",
        top: "0px",
      },
      isDynamic: false,
      inViewport: false,
      parentId: null,
      sharedId: "hl2oJwtxphHDfRv4IgnBW",
      isVariant: true,
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
      variantResponsiveId: "Wwwb1vAbHcIpHpNV5tTDe",
      dynamicFamilyId: "B_SFlYtfu5TvLllqEzHlN",
      independentStyles: {
        left: true,
        top: true,
        position: true,
      },
      position: {
        x: 503.33343505859375,
        y: 0,
      },
      dynamicParentId: "_X9cMMQpXi_hEW4MZ4_2w",
      variantParentId: "_X9cMMQpXi_hEW4MZ4_2w",
      dynamicViewportId: "viewport-375",
    },
    {
      id: "OXsFZ62Z9yaCF5w-VBVEx",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "As0WCJv0sTl2_a5db2UWY",
      dynamicViewportId: "viewport-1440",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "As0WCJv0sTl2_a5db2UWY",
      variantIndependentSync: {},
      variantResponsiveId: "2YohchhDlozFz1Gw3TXdL",
    },
    {
      id: "AoJEkKONrIc8TG63_4BtH",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "As0WCJv0sTl2_a5db2UWY",
      dynamicViewportId: "viewport-768",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "FRkSqx5xLg9P4W-Sm4G-P",
      variantIndependentSync: {},
      variantResponsiveId: "2YohchhDlozFz1Gw3TXdL",
    },
    {
      id: "38VsKIZXKw-azZHchPab0",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "As0WCJv0sTl2_a5db2UWY",
      dynamicViewportId: "viewport-375",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "_X9cMMQpXi_hEW4MZ4_2w",
      variantIndependentSync: {},
      variantResponsiveId: "2YohchhDlozFz1Gw3TXdL",
    },
    {
      id: "slWw2U10JAsnyRVVoT-Uo",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "As0WCJv0sTl2_a5db2UWY",
      dynamicViewportId: "viewport-1440",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "rVkKT7a3XFKMjvM2rlFO9",
      variantIndependentSync: {},
      variantResponsiveId: "4_XwsvxfdjigxfQ1eF3uU",
      isVariant: true,
      variantParentId: "rVkKT7a3XFKMjvM2rlFO9",
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
    },
    {
      id: "afpIip9FUw42ZMI65tznN",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "FRkSqx5xLg9P4W-Sm4G-P",
      dynamicViewportId: "viewport-768",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "HdRQOn2pJO9DIenmjJJjW",
      variantIndependentSync: {},
      variantResponsiveId: "4_XwsvxfdjigxfQ1eF3uU",
      isVariant: true,
      variantParentId: "HdRQOn2pJO9DIenmjJJjW",
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
    },
    {
      id: "rnTNQMD0PUPU1ia9q-h77",
      type: "frame",
      style: {
        position: "relative",
        left: "",
        top: "",
        width: "150px",
        height: "610px",
        backgroundColor: "#2e3841",
        flex: "0 0 auto",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: "",
      },
      inViewport: true,
      dynamicParentId: "_X9cMMQpXi_hEW4MZ4_2w",
      dynamicViewportId: "viewport-375",
      sharedId: "Qu8T732XQFesZJ8YwtRl9",
      unsyncFromParentViewport: {},
      independentStyles: {},
      lowerSyncProps: {},
      parentId: "y5GAuftHf033N31R1IbKN",
      variantIndependentSync: {},
      variantResponsiveId: "4_XwsvxfdjigxfQ1eF3uU",
      isVariant: true,
      variantParentId: "y5GAuftHf033N31R1IbKN",
      variantInfo: {
        name: "Variant 517",
        id: "variant-337",
      },
    },
  ];

  // Simple nanoid replacement for demo purposes
  function nanoid() {
    return Math.random().toString(36).substring(2, 15);
  }

  function duplicateDynamicElementTree(nodeTree) {
    // Find the first dynamic node to use as our source
    const sourceNode = nodeTree.find((n) => n.isDynamic);
    if (!sourceNode) {
      console.log("No dynamic node found in the tree");
      return null;
    }

    const originalFamilyId = sourceNode.dynamicFamilyId;

    // Include ALL nodes in the family, including children
    const familyNodes = nodeTree.filter(
      (n) =>
        n.dynamicFamilyId === originalFamilyId ||
        // Also include nodes that have a parentId pointing to nodes in the family
        nodeTree.some(
          (parent) =>
            parent.dynamicFamilyId === originalFamilyId &&
            n.parentId === parent.id
        )
    );

    console.log(
      `Found ${familyNodes.length} nodes in family ${originalFamilyId} (including children)`
    );

    // Create maps for the various ID types that need to be preserved across nodes
    const idMappings = {
      ids: new Map(), // Regular node IDs - each gets unique value
      sharedIds: new Map(), // ShardIds - same sharedId gets same new value
      dynamicFamilyIds: new Map(), // All get the same new family ID
      variantResponsiveIds: new Map(), // Same responsive ID gets same new value
      variantInfoIds: new Map(), // Same variant info ID gets same new value
    };

    // Create a single new family ID to use for all nodes
    const newFamilyId = nanoid();
    idMappings.dynamicFamilyIds.set(originalFamilyId, newFamilyId);

    // First pass: Create mappings for all IDs that need to be consistent
    familyNodes.forEach((node) => {
      // Create new unique ID for each node
      idMappings.ids.set(node.id, nanoid());

      // Map sharedIds - same old ID gets same new ID
      if (node.sharedId && !idMappings.sharedIds.has(node.sharedId)) {
        idMappings.sharedIds.set(node.sharedId, nanoid());
      }

      // Map variantResponsiveIds - same old ID gets same new ID
      if (
        node.variantResponsiveId &&
        !idMappings.variantResponsiveIds.has(node.variantResponsiveId)
      ) {
        idMappings.variantResponsiveIds.set(node.variantResponsiveId, nanoid());
      }

      // Map variantInfo.id values - same old ID gets same new ID
      if (
        node.variantInfo?.id &&
        !idMappings.variantInfoIds.has(node.variantInfo.id)
      ) {
        idMappings.variantInfoIds.set(
          node.variantInfo.id,
          `variant-${Math.floor(Math.random() * 10000)}`
        );
      }
    });

    // Second pass: Create duplicate nodes with new IDs
    const newNodes = familyNodes.map((originalNode) => {
      // Deep clone the node
      const newNode = JSON.parse(JSON.stringify(originalNode));

      // Set the new ID
      newNode.id = idMappings.ids.get(originalNode.id);

      // Update dynamicFamilyId if this node has one
      if (originalNode.dynamicFamilyId) {
        newNode.dynamicFamilyId = newFamilyId;
      }

      // Update sharedId if present
      if (originalNode.sharedId) {
        newNode.sharedId = idMappings.sharedIds.get(originalNode.sharedId);
      }

      // Update variantResponsiveId if present
      if (originalNode.variantResponsiveId) {
        newNode.variantResponsiveId = idMappings.variantResponsiveIds.get(
          originalNode.variantResponsiveId
        );
      }

      // Update variantInfo.id if present
      if (originalNode.variantInfo?.id) {
        newNode.variantInfo = {
          ...originalNode.variantInfo,
          id: idMappings.variantInfoIds.get(originalNode.variantInfo.id),
        };
      }

      // If this is the source node, move it over (for visualization only)
      if (originalNode.id === sourceNode.id && newNode.position) {
        newNode.position = {
          x: (originalNode.position.x || 0) + 500,
          y: originalNode.position.y || 0,
        };

        if (newNode.style && typeof newNode.style.left === "string") {
          const left = parseFloat(newNode.style.left) || 0;
          newNode.style.left = `${left + 500}px`;
        }
      }

      return newNode;
    });

    // Third pass: Update references between nodes
    newNodes.forEach((newNode) => {
      // Update parentId references
      if (newNode.parentId && idMappings.ids.has(newNode.parentId)) {
        newNode.parentId = idMappings.ids.get(newNode.parentId);
      }

      // Update dynamicParentId references
      if (
        newNode.dynamicParentId &&
        idMappings.ids.has(newNode.dynamicParentId)
      ) {
        newNode.dynamicParentId = idMappings.ids.get(newNode.dynamicParentId);
      }

      // Update variantParentId references
      if (
        newNode.variantParentId &&
        idMappings.ids.has(newNode.variantParentId)
      ) {
        newNode.variantParentId = idMappings.ids.get(newNode.variantParentId);
      }
    });

    // Print some info for verification
    console.log("\nNode types in result:");
    const dynamicCount = newNodes.filter((n) => n.isDynamic).length;
    const variantCount = newNodes.filter((n) => n.isVariant).length;
    const childCount = newNodes.filter(
      (n) => !n.isDynamic && !n.isVariant
    ).length;
    console.log(`Dynamic nodes: ${dynamicCount}`);
    console.log(`Variant nodes: ${variantCount}`);
    console.log(`Child nodes: ${childCount}`);

    // Return the nodes in the same array format as the input
    return newNodes;
  }

  // For testing
  const result = duplicateDynamicElementTree(inputNodeTree);
  console.log(JSON.stringify(result, null, 2)); // Pretty print the result as flat JSON
  return <div>DuplicateDyna</div>;
};

export default DuplicateDyna;
